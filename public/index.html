<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Week Calendar</title>
  <style>
    :root {
      --bg: #f8f9fa;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #1a202c;
      --text-light: #718096;
      --accent: #4f6ef7;
      --accent-light: #ebf0ff;
      --today-bg: #f0f4ff;
      --event-bg: #4f6ef7;
      --event-text: #ffffff;
      --radius: 10px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }

    /* --- Feed input bar --- */
    .feed-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }
    .feed-bar input {
      flex: 1;
      padding: 0.65rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s;
    }
    .feed-bar input:focus {
      border-color: var(--accent);
    }
    .feed-bar button {
      padding: 0.65rem 1.5rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    .feed-bar button:hover { opacity: 0.85; }

    /* --- Week navigation --- */
    .week-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .week-nav .label {
      font-weight: 600;
      font-size: 1.1rem;
    }
    .week-nav .btns {
      display: flex;
      gap: 0.4rem;
    }
    .week-nav button {
      padding: 0.4rem 0.9rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: background 0.15s;
    }
    .week-nav button:hover { background: var(--accent-light); }

    /* --- Week grid --- */
    .week-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .day-col {
      background: var(--card);
      min-height: 160px;
      display: flex;
      flex-direction: column;
    }
    .day-col.today {
      background: var(--today-bg);
    }

    .day-header {
      text-align: center;
      padding: 0.6rem 0.4rem;
      border-bottom: 1px solid var(--border);
    }
    .day-header .dow {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-light);
    }
    .day-header .date {
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 0.15rem;
    }
    .day-col.today .day-header .date {
      color: var(--accent);
    }

    .day-events {
      flex: 1;
      padding: 0.35rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      overflow-y: auto;
    }

    .event {
      background: var(--event-bg);
      color: var(--event-text);
      border-radius: 6px;
      padding: 0.35rem 0.5rem;
      font-size: 0.78rem;
      line-height: 1.3;
    }
    .event .event-time {
      opacity: 0.85;
      font-size: 0.7rem;
    }
    .event .event-title {
      font-weight: 600;
    }
    .event .event-location {
      opacity: 0.8;
      font-size: 0.7rem;
      font-style: italic;
    }

    .empty-state {
      text-align: center;
      color: var(--text-light);
      padding: 3rem 1rem;
      font-size: 0.95rem;
    }

    .status {
      text-align: center;
      padding: 1rem;
      color: var(--text-light);
      font-size: 0.9rem;
    }
    .status.error { color: #e53e3e; }

    /* responsive */
    @media (max-width: 640px) {
      .week-grid {
        grid-template-columns: 1fr;
      }
      .day-col { min-height: auto; }
      .day-header {
        display: flex;
        gap: 0.5rem;
        align-items: baseline;
        padding: 0.5rem 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Week Calendar</h1>

    <div class="feed-bar">
      <input
        id="feedUrl"
        type="url"
        placeholder="Paste an ICS feed URL here..."
      />
      <button id="loadBtn">Load</button>
    </div>

    <div id="calendar"></div>
  </div>

  <script>
    // ---- State ----
    let events = [];
    let weekOffset = 0; // 0 = current week

    const $ = (sel) => document.querySelector(sel);

    // ---- ICS Parser (minimal) ----
    function parseICS(text) {
      const parsed = [];
      const blocks = text.split("BEGIN:VEVENT");
      for (let i = 1; i < blocks.length; i++) {
        const block = blocks[i].split("END:VEVENT")[0];
        const ev = {};

        // Unfold long lines (RFC 5545: lines starting with space are continuations)
        const unfolded = block.replace(/\r?\n[ \t]/g, "");

        for (const line of unfolded.split(/\r?\n/)) {
          const colonIdx = line.indexOf(":");
          if (colonIdx < 0) continue;
          const key = line.slice(0, colonIdx);
          const val = line.slice(colonIdx + 1);

          if (key.startsWith("DTSTART")) ev.dtstart = parseICSDate(key, val);
          else if (key.startsWith("DTEND")) ev.dtend = parseICSDate(key, val);
          else if (key === "SUMMARY") ev.summary = val;
          else if (key === "LOCATION") ev.location = val;
          else if (key === "DESCRIPTION") ev.description = val;
        }

        if (ev.dtstart && ev.summary) parsed.push(ev);
      }
      return parsed;
    }

    function parseICSDate(key, val) {
      // Handle TZID parameter: DTSTART;TZID=Europe/Zurich:20260214T194500
      // We'll parse the local time and treat it as-is for display purposes
      const clean = val.replace(/[^0-9T]/g, "");
      if (clean.length >= 15) {
        // 20260214T194500
        const y = clean.slice(0, 4);
        const m = clean.slice(4, 6);
        const d = clean.slice(6, 8);
        const h = clean.slice(9, 11);
        const mi = clean.slice(11, 13);
        // If ends with Z, it's UTC; otherwise treat as local
        if (val.endsWith("Z")) {
          return new Date(Date.UTC(+y, +m - 1, +d, +h, +mi));
        }
        return new Date(+y, +m - 1, +d, +h, +mi);
      } else if (clean.length >= 8) {
        // All-day: 20260214
        const y = clean.slice(0, 4);
        const m = clean.slice(4, 6);
        const d = clean.slice(6, 8);
        return new Date(+y, +m - 1, +d);
      }
      return null;
    }

    // ---- Week helpers ----
    function getWeekStart(offset) {
      const now = new Date();
      const day = now.getDay(); // 0=Sun
      const monday = new Date(now);
      monday.setDate(now.getDate() - ((day + 6) % 7) + offset * 7);
      monday.setHours(0, 0, 0, 0);
      return monday;
    }

    function isSameDay(a, b) {
      return (
        a.getFullYear() === b.getFullYear() &&
        a.getMonth() === b.getMonth() &&
        a.getDate() === b.getDate()
      );
    }

    function formatTime(d) {
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    const DOW = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    const MONTHS = [
      "Jan","Feb","Mar","Apr","May","Jun",
      "Jul","Aug","Sep","Oct","Nov","Dec",
    ];

    // ---- Render ----
    function render() {
      const cal = $("#calendar");

      if (events.length === 0 && weekOffset === 0) {
        cal.innerHTML =
          '<div class="empty-state">Paste an ICS feed URL above and hit Load.</div>';
        return;
      }

      const weekStart = getWeekStart(weekOffset);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);

      const label = `${weekStart.getDate()} ${MONTHS[weekStart.getMonth()]} – ${weekEnd.getDate()} ${MONTHS[weekEnd.getMonth()]} ${weekEnd.getFullYear()}`;

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let html = `
        <div class="week-nav">
          <div class="btns">
            <button onclick="prevWeek()">‹ Prev</button>
            <button onclick="thisWeek()">Today</button>
            <button onclick="nextWeek()">Next ›</button>
          </div>
          <div class="label">${label}</div>
        </div>
        <div class="week-grid">
      `;

      for (let i = 0; i < 7; i++) {
        const day = new Date(weekStart);
        day.setDate(day.getDate() + i);

        const isToday = isSameDay(day, today);
        const dayEvents = events
          .filter((e) => isSameDay(e.dtstart, day))
          .sort((a, b) => a.dtstart - b.dtstart);

        html += `<div class="day-col${isToday ? " today" : ""}">`;
        html += `<div class="day-header">`;
        html += `<div class="dow">${DOW[i]}</div>`;
        html += `<div class="date">${day.getDate()}</div>`;
        html += `</div>`;
        html += `<div class="day-events">`;

        for (const ev of dayEvents) {
          html += `<div class="event">`;
          if (ev.dtend) {
            html += `<div class="event-time">${formatTime(ev.dtstart)} – ${formatTime(ev.dtend)}</div>`;
          }
          html += `<div class="event-title">${escapeHtml(ev.summary)}</div>`;
          if (ev.location) {
            html += `<div class="event-location">${escapeHtml(ev.location)}</div>`;
          }
          html += `</div>`;
        }

        html += `</div></div>`;
      }

      html += `</div>`;
      cal.innerHTML = html;
    }

    function escapeHtml(s) {
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }

    // ---- Navigation ----
    window.prevWeek = () => { weekOffset--; render(); };
    window.nextWeek = () => { weekOffset++; render(); };
    window.thisWeek = () => { weekOffset = 0; render(); };

    // ---- Load feed ----
    async function loadFeed() {
      const url = $("#feedUrl").value.trim();
      if (!url) return;

      const cal = $("#calendar");
      cal.innerHTML = '<div class="status">Loading...</div>';

      try {
        const res = await fetch(`/api/feed?url=${encodeURIComponent(url)}`);
        if (!res.ok) throw new Error(`Server returned ${res.status}`);
        const text = await res.text();
        events = parseICS(text);
        weekOffset = 0;
        render();
      } catch (err) {
        cal.innerHTML = `<div class="status error">Failed to load feed: ${escapeHtml(err.message)}</div>`;
      }
    }

    $("#loadBtn").addEventListener("click", loadFeed);
    $("#feedUrl").addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadFeed();
    });

    // ---- Init ----
    render();
  </script>
</body>
</html>
